<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Qucs-core: acsolver.cpp Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">Qucs-core
   &#160;<span id="projectnumber">0.0.19</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">acsolver.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="acsolver_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * acsolver.cpp - AC solver class implementation</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2004, 2005, 2007, 2008 Stefan Jahn &lt;stefan@lkcc.org&gt;</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * This is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment"> * it under the terms of the GNU General Public License as published by</span>
<a name="l00008"></a>00008 <span class="comment"> * the Free Software Foundation; either version 2, or (at your option)</span>
<a name="l00009"></a>00009 <span class="comment"> * any later version.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * This software is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00014"></a>00014 <span class="comment"> * GNU General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * You should have received a copy of the GNU General Public License</span>
<a name="l00017"></a>00017 <span class="comment"> * along with this package; see the file COPYING.  If not, write to</span>
<a name="l00018"></a>00018 <span class="comment"> * the Free Software Foundation, Inc., 51 Franklin Street - Fifth Floor,</span>
<a name="l00019"></a>00019 <span class="comment"> * Boston, MA 02110-1301, USA.</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * $Id$</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> */</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#if HAVE_CONFIG_H</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor"># include &lt;<a class="code" href="config_8h.html">config.h</a>&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#endif</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;cmath&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="object_8h.html">object.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="complex_8h.html">complex.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="circuit_8h.html" title="The circuit class header file.">circuit.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="sweep_8h.html">sweep.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="net_8h.html">net.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="netdefs_8h.html">netdefs.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="analysis_8h.html" title="The analysis class header file.">analysis.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="nasolver_8h.html">nasolver.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="acsolver_8h.html">acsolver.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="namespacequcs.html">00042</a> <span class="keyword">namespace </span><a class="code" href="structqucs.html">qucs</a> {
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="comment">// Constructor creates an unnamed instance of the acsolver class.</span>
<a name="l00045"></a>00045 <a class="code" href="structqucs_1_1acsolver.html#af9a91c53edde9cfec6fddedf2f87cb61">acsolver::acsolver</a> () : nasolver&lt;nr_complex_t&gt; () {
<a name="l00046"></a>00046   swp = NULL;
<a name="l00047"></a>00047   <a class="code" href="parse__vcd_8y.html#ae0bd5e8ec17b2aad3338041991eb1056">type</a> = <a class="code" href="structqucs.html#add82670b369206f02d6378e495b91639a059e1e026e9f45e1b94e92a7a9af881a">ANALYSIS_AC</a>;
<a name="l00048"></a>00048   setDescription (<span class="stringliteral">&quot;AC&quot;</span>);
<a name="l00049"></a>00049   xn = NULL;
<a name="l00050"></a>00050   noise = 0;
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">// Constructor creates a named instance of the acsolver class.</span>
<a name="l00054"></a><a class="code" href="structqucs_1_1acsolver.html#af9a91c53edde9cfec6fddedf2f87cb61">00054</a> <a class="code" href="structqucs_1_1acsolver.html#af9a91c53edde9cfec6fddedf2f87cb61">acsolver::acsolver</a> (<span class="keywordtype">char</span> * <a class="code" href="parse__mdl_8y.html#aecba4cab5e52994730d1e21424997b33">n</a>) : nasolver&lt;<a class="code" href="complex_8h.html#a7ad1a12245ad87a9d81d6bcc18afacae">nr_complex_t</a>&gt; (n) {
<a name="l00055"></a>00055   <a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a> = NULL;
<a name="l00056"></a>00056   <a class="code" href="classqucs_1_1analysis.html#a84e16eb62c6576385788ea344b2fc6dc">type</a> = <a class="code" href="structqucs.html#add82670b369206f02d6378e495b91639a059e1e026e9f45e1b94e92a7a9af881a">ANALYSIS_AC</a>;
<a name="l00057"></a>00057   <a class="code" href="classqucs_1_1nasolver.html#a629e3245d6077438740cf5c57d50c8e2">setDescription</a> (<span class="stringliteral">&quot;AC&quot;</span>);
<a name="l00058"></a>00058   <a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a> = NULL;
<a name="l00059"></a>00059   <a class="code" href="structqucs_1_1acsolver.html#ae98e03934bc41e2a6bd888bc2cbb5a8d">noise</a> = 0;
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="comment">// Destructor deletes the acsolver class object.</span>
<a name="l00063"></a><a class="code" href="structqucs_1_1acsolver.html#afe020324ca7602190805a28e78e972d6">00063</a> <a class="code" href="structqucs_1_1acsolver.html#afe020324ca7602190805a28e78e972d6">acsolver::~acsolver</a> () {
<a name="l00064"></a>00064   <span class="keyword">delete</span> <a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a>;
<a name="l00065"></a>00065   <span class="keyword">delete</span> <a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a>;
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">/* The copy constructor creates a new instance of the acsolver class</span>
<a name="l00069"></a>00069 <span class="comment">   based on the given acsolver object. */</span>
<a name="l00070"></a><a class="code" href="structqucs_1_1acsolver.html#a0b9c116dee3044d10504e69435bc5510">00070</a> <a class="code" href="structqucs_1_1acsolver.html#af9a91c53edde9cfec6fddedf2f87cb61">acsolver::acsolver</a> (<a class="code" href="structqucs_1_1acsolver.html">acsolver</a> &amp; o) : nasolver&lt;<a class="code" href="complex_8h.html#a7ad1a12245ad87a9d81d6bcc18afacae">nr_complex_t</a>&gt; (o) {
<a name="l00071"></a>00071   <a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a> = o.<a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a> ? <span class="keyword">new</span> sweep (*(o.<a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a>)) : NULL;
<a name="l00072"></a>00072   <a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a> = o.<a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a> ? <span class="keyword">new</span> tvector&lt;nr_double_t&gt; (*(o.<a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a>)) : NULL;
<a name="l00073"></a>00073   <a class="code" href="structqucs_1_1acsolver.html#ae98e03934bc41e2a6bd888bc2cbb5a8d">noise</a> = o.<a class="code" href="structqucs_1_1acsolver.html#ae98e03934bc41e2a6bd888bc2cbb5a8d">noise</a>;
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">/* This is the AC netlist solver.  It prepares the circuit list for</span>
<a name="l00077"></a>00077 <span class="comment">   each requested frequency and solves it then. */</span>
<a name="l00078"></a><a class="code" href="structqucs_1_1acsolver.html#adc297bfd1fb5aa48fbdf664021b37bae">00078</a> <span class="keywordtype">int</span> <a class="code" href="structqucs_1_1acsolver.html#adc297bfd1fb5aa48fbdf664021b37bae" title="placehoder for solution function">acsolver::solve</a> (<span class="keywordtype">void</span>) {
<a name="l00079"></a>00079   <a class="code" href="classqucs_1_1analysis.html#a6dde62cbe375a36a28ca150d5e7dde16">runs</a>++;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081   <span class="comment">// run additional noise analysis ?</span>
<a name="l00082"></a>00082   <a class="code" href="structqucs_1_1acsolver.html#ae98e03934bc41e2a6bd888bc2cbb5a8d">noise</a> = !strcmp (<a class="code" href="classqucs_1_1object.html#a36314693916e9ee95c839b05b973d95b">getPropertyString</a> (<span class="stringliteral">&quot;Noise&quot;</span>), <span class="stringliteral">&quot;yes&quot;</span>) ? 1 : 0;
<a name="l00083"></a>00083 
<a name="l00084"></a>00084   <span class="comment">// create frequency sweep if necessary</span>
<a name="l00085"></a>00085   <span class="keywordflow">if</span> (<a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a> == NULL) {
<a name="l00086"></a>00086     <a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a> = <a class="code" href="classqucs_1_1analysis.html#aff64572418ae49d0a264d3a8ec4d2a73" title="create a named sweep object">createSweep</a> (<span class="stringliteral">&quot;acfrequency&quot;</span>);
<a name="l00087"></a>00087   }
<a name="l00088"></a>00088 
<a name="l00089"></a>00089   <span class="comment">// initialize node voltages, first guess for non-linear circuits and</span>
<a name="l00090"></a>00090   <span class="comment">// generate extra circuits if necessary</span>
<a name="l00091"></a>00091   <a class="code" href="structqucs_1_1acsolver.html#aee465a57d6c2ab004ec0b90e319804af">init</a> ();
<a name="l00092"></a>00092   <a class="code" href="classqucs_1_1nasolver.html#ad5b0796e64c30a8f4cf5f0a09ffc38ae">setCalculation</a> ((<a class="code" href="classqucs_1_1nasolver.html#a8a804b1f4ba868913a6da2568bdf75e4">calculate_func_t</a>) &amp;<a class="code" href="structqucs_1_1acsolver.html#acfaa33b57948c9a443d7666185e202af">calc</a>);
<a name="l00093"></a>00093   <a class="code" href="classqucs_1_1nasolver.html#a880c216ea3ca329c03e78f5caf6e6fd4">solve_pre</a> ();
<a name="l00094"></a>00094 
<a name="l00095"></a>00095   <a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a>-&gt;reset ();
<a name="l00096"></a>00096   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a> = 0; <a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a> &lt; <a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a>-&gt;getSize (); <a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a>++) {
<a name="l00097"></a>00097     <a class="code" href="structqucs_1_1acsolver.html#a53ec4f7a203a8ee0373108d0c303391b">freq</a> = <a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a>-&gt;next ();
<a name="l00098"></a>00098     <span class="keywordflow">if</span> (<a class="code" href="classqucs_1_1analysis.html#a7812270e270b37ac9e783794dfea0113">progress</a>) <a class="code" href="logging_8c.html#a81eabf431f4c406062f223e3d5f4a1b7">logprogressbar</a> (<a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a>, <a class="code" href="structqucs_1_1acsolver.html#abf8eb5ed59e89ef42e5576078eac3aa8">swp</a>-&gt;getSize (), 40);
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="preprocessor">#if DEBUG &amp;&amp; 0</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>    <a class="code" href="logging_8c.html#abe06a8732a47a291606edcfac5e5146e">logprint</a> (<a class="code" href="logging_8h.html#a9b52156aa5746cc612e2e3edea6d5dbd">LOG_STATUS</a>, <span class="stringliteral">&quot;NOTIFY: %s: solving netlist for f = %e\n&quot;</span>,
<a name="l00102"></a>00102               <a class="code" href="classqucs_1_1object.html#a3134f6d4b6abda0fb40ac2a9fb4344cc" title="Get the name of the object.">getName</a> (), (<span class="keywordtype">double</span>) <a class="code" href="structqucs_1_1acsolver.html#a53ec4f7a203a8ee0373108d0c303391b">freq</a>);
<a name="l00103"></a>00103 <span class="preprocessor">#endif</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>
<a name="l00105"></a>00105     <span class="comment">// start the linear solver</span>
<a name="l00106"></a>00106     <a class="code" href="classqucs_1_1nasolver.html#a6431ca92d391749f2025db3446fd2c68">eqnAlgo</a> = <a class="code" href="eqnsys_8h.html#a92b72228de8e945a7cbdf109a4e3c14fa6cea149798988dc30e1b4186f8a3c8dd">ALGO_LU_DECOMPOSITION</a>;
<a name="l00107"></a>00107     <a class="code" href="classqucs_1_1nasolver.html#aa6569bfed1dfee556ee79842373509bf">solve_linear</a> ();
<a name="l00108"></a>00108 
<a name="l00109"></a>00109     <span class="comment">// compute noise if requested</span>
<a name="l00110"></a>00110     <span class="keywordflow">if</span> (<a class="code" href="structqucs_1_1acsolver.html#ae98e03934bc41e2a6bd888bc2cbb5a8d">noise</a>) <a class="code" href="structqucs_1_1acsolver.html#a0e06c6798f7e191cd04496927f03f9a5">solve_noise</a> ();
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     <span class="comment">// save results</span>
<a name="l00113"></a>00113     <a class="code" href="structqucs_1_1acsolver.html#adfb35238fddd432e89c3d82394ca65fa">saveAllResults</a> (freq);
<a name="l00114"></a>00114   }
<a name="l00115"></a>00115   <a class="code" href="classqucs_1_1nasolver.html#a92600d02c4b536170044834e2a8531f6">solve_post</a> ();
<a name="l00116"></a>00116   <span class="keywordflow">if</span> (<a class="code" href="classqucs_1_1analysis.html#a7812270e270b37ac9e783794dfea0113">progress</a>) <a class="code" href="logging_8c.html#ae978b0a54ab3a7b39fa6c540df3907c6">logprogressclear</a> (40);
<a name="l00117"></a>00117   <span class="keywordflow">return</span> 0;
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="comment">/* Goes through the list of circuit objects and runs its calcAC()</span>
<a name="l00121"></a>00121 <span class="comment">   function. */</span>
<a name="l00122"></a><a class="code" href="structqucs_1_1acsolver.html#acfaa33b57948c9a443d7666185e202af">00122</a> <span class="keywordtype">void</span> <a class="code" href="structqucs_1_1acsolver.html#acfaa33b57948c9a443d7666185e202af">acsolver::calc</a> (<a class="code" href="structqucs_1_1acsolver.html">acsolver</a> * <span class="keyword">self</span>) {
<a name="l00123"></a>00123   circuit * root = <span class="keyword">self</span>-&gt;getNet()-&gt;getRoot ();
<a name="l00124"></a>00124   <span class="keywordflow">for</span> (circuit * <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> = root; <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> != NULL; <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> = (circuit *) <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;getNext ()) {
<a name="l00125"></a>00125     <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;calcAC (self-&gt;freq);
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (self-&gt;noise) <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;calcNoiseAC (self-&gt;freq);
<a name="l00127"></a>00127   }
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="comment">/* Goes through the list of circuit objects and runs its initAC()</span>
<a name="l00131"></a>00131 <span class="comment">   function. */</span>
<a name="l00132"></a><a class="code" href="structqucs_1_1acsolver.html#aee465a57d6c2ab004ec0b90e319804af">00132</a> <span class="keywordtype">void</span> <a class="code" href="structqucs_1_1acsolver.html#aee465a57d6c2ab004ec0b90e319804af">acsolver::init</a> (<span class="keywordtype">void</span>) {
<a name="l00133"></a>00133   circuit * root = <a class="code" href="classqucs_1_1analysis.html#af7950ac4e6fa521e27fde78141030917">subnet</a>-&gt;getRoot ();
<a name="l00134"></a>00134   <span class="keywordflow">for</span> (circuit * <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> = root; <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> != NULL; <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> = (circuit *) <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;getNext ()) {
<a name="l00135"></a>00135     <span class="keywordflow">if</span> (<a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;isNonLinear ()) <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;calcOperatingPoints ();
<a name="l00136"></a>00136     <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;initAC ();
<a name="l00137"></a>00137     <span class="keywordflow">if</span> (<a class="code" href="structqucs_1_1acsolver.html#ae98e03934bc41e2a6bd888bc2cbb5a8d">noise</a>) <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;initNoiseAC ();
<a name="l00138"></a>00138   }
<a name="l00139"></a>00139 }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 <span class="comment">/* This function saves the results of a single solve() functionality</span>
<a name="l00142"></a>00142 <span class="comment">   (for the given frequency) into the output dataset. */</span>
<a name="l00143"></a><a class="code" href="structqucs_1_1acsolver.html#adfb35238fddd432e89c3d82394ca65fa">00143</a> <span class="keywordtype">void</span> <a class="code" href="structqucs_1_1acsolver.html#adfb35238fddd432e89c3d82394ca65fa">acsolver::saveAllResults</a> (<a class="code" href="config_8h.html#a014aadc409afb297b8247c13f8ca89be">nr_double_t</a> freq) {
<a name="l00144"></a>00144   qucs::vector * f;
<a name="l00145"></a>00145   <span class="comment">// add current frequency to the dependency of the output dataset</span>
<a name="l00146"></a>00146   <span class="keywordflow">if</span> ((f = <a class="code" href="classqucs_1_1analysis.html#a0d8e30bda647046453aaa0cf88c0fafe">data</a>-&gt;findDependency (<span class="stringliteral">&quot;acfrequency&quot;</span>)) == NULL) {
<a name="l00147"></a>00147     f = <span class="keyword">new</span> qucs::vector (<span class="stringliteral">&quot;acfrequency&quot;</span>);
<a name="l00148"></a>00148     <a class="code" href="classqucs_1_1analysis.html#a0d8e30bda647046453aaa0cf88c0fafe">data</a>-&gt;addDependency (f);
<a name="l00149"></a>00149   }
<a name="l00150"></a>00150   <span class="keywordflow">if</span> (<a class="code" href="classqucs_1_1analysis.html#a6dde62cbe375a36a28ca150d5e7dde16">runs</a> == 1) f-&gt;add (freq);
<a name="l00151"></a>00151   <a class="code" href="classqucs_1_1nasolver.html#a45e8941aa74dec4799210aa4072d31cc">saveResults</a> (<span class="stringliteral">&quot;v&quot;</span>, <span class="stringliteral">&quot;i&quot;</span>, 0, f);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153   <span class="comment">// additionally save noise results if requested</span>
<a name="l00154"></a>00154   <span class="keywordflow">if</span> (<a class="code" href="structqucs_1_1acsolver.html#ae98e03934bc41e2a6bd888bc2cbb5a8d">noise</a>) {
<a name="l00155"></a>00155     <a class="code" href="structqucs_1_1acsolver.html#a974a541f84f00693d7ab1e24ae88316f">saveNoiseResults</a> (f);
<a name="l00156"></a>00156   }
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159 <span class="comment">/* The function computes the final noise results and puts them into</span>
<a name="l00160"></a>00160 <span class="comment">   the output dataset. */</span>
<a name="l00161"></a><a class="code" href="structqucs_1_1acsolver.html#a974a541f84f00693d7ab1e24ae88316f">00161</a> <span class="keywordtype">void</span> <a class="code" href="structqucs_1_1acsolver.html#a974a541f84f00693d7ab1e24ae88316f">acsolver::saveNoiseResults</a> (qucs::vector * f) {
<a name="l00162"></a>00162   <span class="keywordtype">int</span> <a class="code" href="equation_8cpp.html#a540f72cb9bcf86a19e3bbc259b9ec3e0">N</a> = <a class="code" href="classqucs_1_1nasolver.html#a32f6859eb73548191778080b37c71ac0">countNodes</a> ();
<a name="l00163"></a>00163   <span class="keywordtype">int</span> <a class="code" href="evaluate_8cpp.html#a92592142cb41364b6fe6ef9cc1a16dbd">M</a> = <a class="code" href="classqucs_1_1nasolver.html#a5430c3ad45bf7327d9f1e343159d0f43">countVoltageSources</a> ();
<a name="l00164"></a>00164   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="parse__mdl_8y.html#a514f1b439f404f86f77090fa9edc96ce">r</a> = 0; <a class="code" href="parse__mdl_8y.html#a514f1b439f404f86f77090fa9edc96ce">r</a> &lt; N + <a class="code" href="evaluate_8cpp.html#a92592142cb41364b6fe6ef9cc1a16dbd">M</a>; <a class="code" href="parse__mdl_8y.html#a514f1b439f404f86f77090fa9edc96ce">r</a>++) {
<a name="l00165"></a>00165     <span class="comment">// renormalise the results</span>
<a name="l00166"></a>00166     <a class="code" href="classqucs_1_1nasolver.html#a04596b58e70446c7fa14d832461c0f0b">x</a>-&gt;set (<a class="code" href="parse__mdl_8y.html#a514f1b439f404f86f77090fa9edc96ce">r</a>, fabs (<a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a>-&gt;get (<a class="code" href="parse__mdl_8y.html#a514f1b439f404f86f77090fa9edc96ce">r</a>) * <a class="code" href="namespacequcs.html#adeb767aff95d4dcd7a53f06b39dc1084" title="Compute principal value of square root.">sqrt</a> (<a class="code" href="group__qucsPhysConstants.html#ga0d8f03a5334f35172c7702f6db2f87bd" title="Boltzmann constant ( )">kB</a> * <a class="code" href="group__qucsPhysConstants.html#ga9a5dcfcfc8f0501b467537138ec1661a" title="standard temperature">T0</a>)));
<a name="l00167"></a>00167   }
<a name="l00168"></a>00168 
<a name="l00169"></a>00169   <span class="comment">// apply probe data</span>
<a name="l00170"></a>00170   circuit * root = <a class="code" href="classqucs_1_1analysis.html#af7950ac4e6fa521e27fde78141030917">subnet</a>-&gt;getRoot ();
<a name="l00171"></a>00171   <span class="keywordflow">for</span> (circuit * <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> = root; <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> != NULL; <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a> = (circuit *) <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;getNext ()) {
<a name="l00172"></a>00172     <span class="keywordflow">if</span> (!<a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;isProbe ()) <span class="keywordflow">continue</span>;
<a name="l00173"></a>00173     <span class="keywordtype">int</span> np, nn;
<a name="l00174"></a>00174     <a class="code" href="config_8h.html#a014aadc409afb297b8247c13f8ca89be">nr_double_t</a> vp, vn;
<a name="l00175"></a>00175     np = <a class="code" href="classqucs_1_1nasolver.html#a07d28072d8389ef21dc63a33307f65e6">getNodeNr</a> (<a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;getNode (<a class="code" href="circuit_8h.html#a4f0d36c5244b59c0f92e7704ac05647f">NODE_1</a>)-&gt;getName ());
<a name="l00176"></a>00176     vp = np &gt; 0 ? <a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a>-&gt;get (np - 1) : 0.0;
<a name="l00177"></a>00177     nn = <a class="code" href="classqucs_1_1nasolver.html#a07d28072d8389ef21dc63a33307f65e6">getNodeNr</a> (<a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;getNode (<a class="code" href="circuit_8h.html#a6685ff6eaa6d17e48acf55cc8434eaed">NODE_2</a>)-&gt;getName ());
<a name="l00178"></a>00178     vn = nn &gt; 0 ? <a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a>-&gt;get (nn - 1) : 0.0;
<a name="l00179"></a>00179     <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;setOperatingPoint (<span class="stringliteral">&quot;Vr&quot;</span>, fabs ((vp - vn) * <a class="code" href="namespacequcs.html#adeb767aff95d4dcd7a53f06b39dc1084" title="Compute principal value of square root.">sqrt</a> (<a class="code" href="group__qucsPhysConstants.html#ga0d8f03a5334f35172c7702f6db2f87bd" title="Boltzmann constant ( )">kB</a> * <a class="code" href="group__qucsPhysConstants.html#ga9a5dcfcfc8f0501b467537138ec1661a" title="standard temperature">T0</a>)));
<a name="l00180"></a>00180     <a class="code" href="parse__netlist_8y.html#a519cf159c27abd2374c9f649b9e9946d">c</a>-&gt;setOperatingPoint (<span class="stringliteral">&quot;Vi&quot;</span>, 0.0);
<a name="l00181"></a>00181   }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183   <a class="code" href="classqucs_1_1nasolver.html#a45e8941aa74dec4799210aa4072d31cc">saveResults</a> (<span class="stringliteral">&quot;vn&quot;</span>, <span class="stringliteral">&quot;in&quot;</span>, 0, f);
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="comment">/* This function runs the AC noise analysis.  It saves its results in</span>
<a name="l00187"></a>00187 <span class="comment">   the &#39;xn&#39; vector. */</span>
<a name="l00188"></a><a class="code" href="structqucs_1_1acsolver.html#a0e06c6798f7e191cd04496927f03f9a5">00188</a> <span class="keywordtype">void</span> <a class="code" href="structqucs_1_1acsolver.html#a0e06c6798f7e191cd04496927f03f9a5">acsolver::solve_noise</a> (<span class="keywordtype">void</span>) {
<a name="l00189"></a>00189   <span class="keywordtype">int</span> <a class="code" href="equation_8cpp.html#a540f72cb9bcf86a19e3bbc259b9ec3e0">N</a> = <a class="code" href="classqucs_1_1nasolver.html#a32f6859eb73548191778080b37c71ac0">countNodes</a> ();
<a name="l00190"></a>00190   <span class="keywordtype">int</span> <a class="code" href="evaluate_8cpp.html#a92592142cb41364b6fe6ef9cc1a16dbd">M</a> = <a class="code" href="classqucs_1_1nasolver.html#a5430c3ad45bf7327d9f1e343159d0f43">countVoltageSources</a> ();
<a name="l00191"></a>00191 
<a name="l00192"></a>00192   <span class="comment">// save usual AC results</span>
<a name="l00193"></a>00193   tvector&lt;nr_complex_t&gt; xsave = *<a class="code" href="classqucs_1_1nasolver.html#a04596b58e70446c7fa14d832461c0f0b">x</a>;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195   <span class="comment">// create the Cy matrix</span>
<a name="l00196"></a>00196   <a class="code" href="classqucs_1_1nasolver.html#a6945245ab021dbf2c688c643a60e972d">createNoiseMatrix</a> ();
<a name="l00197"></a>00197   <span class="comment">// create noise result vector if necessary</span>
<a name="l00198"></a>00198   <span class="keywordflow">if</span> (<a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a> == NULL) <a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a> = <span class="keyword">new</span> tvector&lt;nr_double_t&gt; (N + <a class="code" href="evaluate_8cpp.html#a92592142cb41364b6fe6ef9cc1a16dbd">M</a>);
<a name="l00199"></a>00199 
<a name="l00200"></a>00200   <span class="comment">// temporary result vector for transimpedances</span>
<a name="l00201"></a>00201   tvector&lt;nr_complex_t&gt; zn = tvector&lt;nr_complex_t&gt; (N + <a class="code" href="evaluate_8cpp.html#a92592142cb41364b6fe6ef9cc1a16dbd">M</a>);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203   <span class="comment">// create the MNA matrix once again and LU decompose the adjoint matrix</span>
<a name="l00204"></a>00204   <a class="code" href="classqucs_1_1nasolver.html#a0003b724e5c5801a3fac5d9b2863fb78">createMatrix</a> ();
<a name="l00205"></a>00205   <a class="code" href="classqucs_1_1nasolver.html#ac46d2e86bd0726554c4edee0b882d6b4">A</a>-&gt;transpose ();
<a name="l00206"></a>00206   <a class="code" href="classqucs_1_1nasolver.html#a6431ca92d391749f2025db3446fd2c68">eqnAlgo</a> = <a class="code" href="eqnsys_8h.html#a92b72228de8e945a7cbdf109a4e3c14fa29319b0957f7edc882b81af6a33df823">ALGO_LU_FACTORIZATION_CROUT</a>;
<a name="l00207"></a>00207   <a class="code" href="classqucs_1_1nasolver.html#a53c0bcf9d6f7457f9cc8b9fbe685f66e">runMNA</a> ();
<a name="l00208"></a>00208 
<a name="l00209"></a>00209   <span class="comment">// ensure skipping LU decomposition</span>
<a name="l00210"></a>00210   <a class="code" href="classqucs_1_1nasolver.html#a6523dbb0430b5517e9260b6ae11f7b7a">updateMatrix</a> = 0;
<a name="l00211"></a>00211   <a class="code" href="classqucs_1_1nasolver.html#af245824b9e76d362e6a595cd12c9d649">convHelper</a> = <a class="code" href="nasolver_8h.html#a30c1944130dc208252734935dcefe6e3">CONV_None</a>;
<a name="l00212"></a>00212   <a class="code" href="classqucs_1_1nasolver.html#a6431ca92d391749f2025db3446fd2c68">eqnAlgo</a> = <a class="code" href="eqnsys_8h.html#a92b72228de8e945a7cbdf109a4e3c14fabbe28e4a870859123c42888212546ef9">ALGO_LU_SUBSTITUTION_CROUT</a>;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214   <span class="comment">// compute noise voltage for each node (and voltage source)</span>
<a name="l00215"></a>00215   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a> = 0; <a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a> &lt; N + <a class="code" href="evaluate_8cpp.html#a92592142cb41364b6fe6ef9cc1a16dbd">M</a>; <a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a>++) {
<a name="l00216"></a>00216     <a class="code" href="classqucs_1_1nasolver.html#a7c9d1ec2bd181d6b261117381261d2ce">z</a>-&gt;set (0); <a class="code" href="classqucs_1_1nasolver.html#a7c9d1ec2bd181d6b261117381261d2ce">z</a>-&gt;set (<a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a>, -1); <span class="comment">// modify right hand side appropriately</span>
<a name="l00217"></a>00217     <a class="code" href="classqucs_1_1nasolver.html#a53c0bcf9d6f7457f9cc8b9fbe685f66e">runMNA</a> ();                  <span class="comment">// solve</span>
<a name="l00218"></a>00218     zn = *<a class="code" href="classqucs_1_1nasolver.html#a04596b58e70446c7fa14d832461c0f0b">x</a>;                    <span class="comment">// save transimpedance vector</span>
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="comment">// compute actual noise voltage</span>
<a name="l00221"></a>00221     <a class="code" href="structqucs_1_1acsolver.html#a1f2e0820c28117bbc131d2707da471f8">xn</a>-&gt;set (<a class="code" href="parse__mdl_8y.html#a7e98b8a17c0aad30ba64d47b74e2a6c1">i</a>, <a class="code" href="namespacequcs.html#adeb767aff95d4dcd7a53f06b39dc1084" title="Compute principal value of square root.">sqrt</a> (<a class="code" href="namespacequcs.html#a0cc73c27d7d13b2200f2fddbb064dce6" title="Real part matrix.">real</a> (<a class="code" href="namespacequcs.html#a1d2e73b918570986fd6e48b4a66601ed">scalar</a> (zn * (*<a class="code" href="classqucs_1_1nasolver.html#ab045b75672428d6576672a8ddae829b3">C</a>), <a class="code" href="namespacequcs.html#a691eba7985bd59b01aa1d5d5b845027b" title="Conjugate complex matrix.">conj</a> (zn)))));
<a name="l00222"></a>00222   }
<a name="l00223"></a>00223 
<a name="l00224"></a>00224   <span class="comment">// restore usual AC results</span>
<a name="l00225"></a>00225   *<a class="code" href="classqucs_1_1nasolver.html#a04596b58e70446c7fa14d832461c0f0b">x</a> = xsave;
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="comment">// properties</span>
<a name="l00229"></a><a class="code" href="structqucs.html#a22dddfa38928996c2851157e7609cc33">00229</a> <a class="code" href="structqucs.html#a22dddfa38928996c2851157e7609cc33">PROP_REQ</a> [] = {
<a name="l00230"></a>00230   { <span class="stringliteral">&quot;Type&quot;</span>, <a class="code" href="netdefs_8h.html#a552766d94553aab12e7876b233745eba">PROP_STR</a>, { <a class="code" href="netdefs_8h.html#afb940e1f3110901a9a494273b104f586">PROP_NO_VAL</a>, <span class="stringliteral">&quot;lin&quot;</span> }, <a class="code" href="netdefs_8h.html#a9861c0c15f8372d32981f8f169a08a04">PROP_RNG_TYP</a> },
<a name="l00231"></a>00231   <a class="code" href="netdefs_8h.html#abe2affa5f22fc12b66df2bb2c385af8b">PROP_NO_PROP</a> };
<a name="l00232"></a><a class="code" href="structqucs.html#a23d1ecdd5939cc3ab98c05aed05eb1be">00232</a> <a class="code" href="structqucs.html#a23d1ecdd5939cc3ab98c05aed05eb1be">PROP_OPT</a> [] = {
<a name="l00233"></a>00233   { <span class="stringliteral">&quot;Noise&quot;</span>, <a class="code" href="netdefs_8h.html#a552766d94553aab12e7876b233745eba">PROP_STR</a>, { <a class="code" href="netdefs_8h.html#afb940e1f3110901a9a494273b104f586">PROP_NO_VAL</a>, <span class="stringliteral">&quot;no&quot;</span> }, <a class="code" href="netdefs_8h.html#a4bf829946eefc66a76ba797b92b040a3">PROP_RNG_YESNO</a> },
<a name="l00234"></a>00234   { <span class="stringliteral">&quot;Start&quot;</span>, <a class="code" href="netdefs_8h.html#affd5c5788fc34f8a0ab1b07b77604103">PROP_REAL</a>, { 1e9, <a class="code" href="netdefs_8h.html#a4d0941b8422de2007248d250c7c5c9ed">PROP_NO_STR</a> }, <a class="code" href="netdefs_8h.html#a4980d9d0ee76163dc5bfffbad6fa6213">PROP_POS_RANGE</a> },
<a name="l00235"></a>00235   { <span class="stringliteral">&quot;Stop&quot;</span>, <a class="code" href="netdefs_8h.html#affd5c5788fc34f8a0ab1b07b77604103">PROP_REAL</a>, { 10e9, <a class="code" href="netdefs_8h.html#a4d0941b8422de2007248d250c7c5c9ed">PROP_NO_STR</a> }, <a class="code" href="netdefs_8h.html#a4980d9d0ee76163dc5bfffbad6fa6213">PROP_POS_RANGE</a> },
<a name="l00236"></a>00236   { <span class="stringliteral">&quot;Points&quot;</span>, <a class="code" href="netdefs_8h.html#a1a52c37e7df2d230169832d17a1c0c5c">PROP_INT</a>, { 10, <a class="code" href="netdefs_8h.html#a4d0941b8422de2007248d250c7c5c9ed">PROP_NO_STR</a> }, <a class="code" href="netdefs_8h.html#a87f670224851c2a44bfa1be44eddbb13">PROP_MIN_VAL</a> (2) },
<a name="l00237"></a>00237   { <span class="stringliteral">&quot;Values&quot;</span>, <a class="code" href="netdefs_8h.html#aa98b1758ffaa509c0d79a7cbc3b3c61a">PROP_LIST</a>, { 10, <a class="code" href="netdefs_8h.html#a4d0941b8422de2007248d250c7c5c9ed">PROP_NO_STR</a> }, <a class="code" href="netdefs_8h.html#a4980d9d0ee76163dc5bfffbad6fa6213">PROP_POS_RANGE</a> },
<a name="l00238"></a>00238   <a class="code" href="netdefs_8h.html#abe2affa5f22fc12b66df2bb2c385af8b">PROP_NO_PROP</a> };
<a name="l00239"></a><a class="code" href="structqucs_1_1acsolver.html">00239</a> <span class="keyword">struct </span><a class="code" href="structdefine__t.html">define_t</a> <a class="code" href="structqucs_1_1acsolver.html">acsolver</a>::anadef =
<a name="l00240"></a><a class="code" href="structqucs_1_1acsolver.html#a6ded71b9df2415f0bee27a8cf724b157">00240</a>   { <span class="stringliteral">&quot;AC&quot;</span>, 0, <a class="code" href="netdefs_8h.html#a7f2eed3c8b53ad19237413982b693f6f">PROP_ACTION</a>, <a class="code" href="structqucs_1_1acsolver.html#a6ded71b9df2415f0bee27a8cf724b157">PROP_NO_SUBSTRATE</a>, <a class="code" href="netdefs_8h.html#abbc3dc5d6e7ed19e109e2c80caba81bf">PROP_LINEAR</a>, <a class="code" href="netdefs_8h.html#acd1661cbcb5d1e27c3cf1b93f5ef8153">PROP_DEF</a> };
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 } <span class="comment">// namespace qucs</span>
</pre></div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated on Fri Jan 22 2016 00:39:29 for Qucs-core by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.6.1
</small></address>

</body>
</html>
